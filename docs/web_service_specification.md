# 서비스 기획서 (Service Specification)

> 주식 초보자(주린이)를 위해 챗봇의 접근성과 웹의 시각적 정보를 결합하여,
> 쉽고 직관적인 투자 정보를 제공

**타겟 디바이스:** Mobile Web (카카오톡 인앱 브라우저 최적화)

---

## 서비스 개요

| 항목 | 내용 |
|------|------|
| 프로젝트 목적 | 카카오톡 챗봇을 중심으로 주식 정보를 제공하고, 차트·리포트 등 복잡한 UI는 웹에서 제공 |
| 주요 타겟 | 주식을 잘 모르는 초보 사용자 및 주식 보유자 |
| 핵심 전략 | 챗봇 = 진입·요약 / 웹 = 상세·시각화(차트) |
| Web의 역할 | 차트 제공, 상세 리포트 제공, 투자 요약 제공, 반응 요약 제공 |
| 진입 방식 | 카카오톡 챗봇 webLink 버튼 (임시로 지정) |

---

## 기능명세서

---

# Web_01. 종목 차트 페이지

## 0. 전제/정책

- Web_01 종목 차트는 **계좌 연동 없이 사용 가능**
- 계좌 미연동 제한 기능: 거래내역/상세/요약/물타기 → Web_03~04에서 잠금 처리

---

## 1. 서비스 전달 방법

- 서버에서 Plotly HTML/JSON을 만들어 프론트에 전달
  - 백엔드: `fig.to_json()`
  - 프론트는 Plotly.js로 그대로 렌더링

---

## 2. 화면 요구사항

### 2-1. 기간 탭 (고정)

| 탭 | 설명 |
|----|------|
| 하루 | 일중 차트 (5분봉) |
| 1달 | 일봉 30일 |
| 3달 | 일봉 90일 |
| 1년 | 일봉 365일 |

- 탭 변경 시 즉시 로딩 표시 → 차트 갱신

### 2-2. 차트 기본 타입

| 구분 | 내용 |
|------|------|
| 기본 화면 | 캔들스틱 + MA(5, 20, 60) |
| 보조 기능 (고도화) | 기술적(볼린저+RSI), 거래량, 라인(가격 추이) |

---

## 3. 데이터 준비사항

### 3-1. 기간 파라미터 매핑

| 웹 Range | days 매핑 | 차트 타입 | 비고 |
|----------|-----------|-----------|------|
| 하루 (1d) | - | 5분봉 | 별도 분봉 API 필요 |
| 1달 (1m) | 30 | 일봉 | |
| 3달 (3m) | 90 | 일봉 | |
| 1년 (1y) | 365 | 일봉 | |

### 3-2. 서버 전달 포맷

```json
{
  "symbol": "005930",
  "range": "3m",
  "type": "candlestick",
  "plotly": { "fig.to_json() 결과" },
  "meta": {
    "ma": [5, 20, 60],
    "generatedAt": "ISO8601"
  }
}
```

---

## 4. API 명세

### 4-1. 공통 규칙

- `symbol` (종목코드): 필수
- `range`: 필수 (`1d` | `1m` | `3m` | `1y`)
- `type`: 선택 (`candlestick` | `technical` | `line` | `volume`)

### 4-2. 엔드포인트

```
GET /api/web/stocks/{symbol}/chart
```

**Query Parameters:**
| 파라미터 | 필수 | 기본값 | 설명 |
|----------|------|--------|------|
| range | ✅ | - | `1d`, `1m`, `3m`, `1y` |
| type | ❌ | `candlestick` | 차트 타입 |

**Response:**
```json
{
  "symbol": "005930",
  "range": "3m",
  "type": "candlestick",
  "plotly": { "..." },
  "meta": {
    "ma": [5, 20, 60],
    "generatedAt": "2026-01-24T10:30:00"
  }
}
```

**에러 응답:**
```json
{
  "plotly": null,
  "meta": {
    "reason": "NO_DATA"
  }
}
```

### 4-3. 캐싱 정책

| Range | TTL | 비고 |
|-------|-----|------|
| 1d | 10~60초 | 일중 실시간 |
| 1m | 5분 | |
| 3m | 15분 | |
| 1y | 30분 | |

---

## 5. 프론트엔드 준비사항

### 5-1. 컴포넌트 구조

| 컴포넌트 | 역할 |
|----------|------|
| `ChartHeader` | 종목명/현재가/등락 표시 |
| `RangeTabs` | 하루/1달/3달/1년 탭 |
| `ChartRenderer` | Plotly 렌더 영역 |
| `ChartTypeToggle` | 캔들/라인/기술적/거래량 (선택) |

### 5-2. 동작 흐름

1. **최초 진입**: `range=1m`, `type=candlestick` 호출
2. **탭 클릭**: 로딩 스켈레톤 → API 재호출 → plotly 렌더 교체
3. **실패 시**: 재시도 버튼 + 빈 상태 UI

### 5-3. Plotly 렌더 방식

- `plotly.js` 또는 `react-plotly.js` 사용
- 반응형 크기(모바일) 대응: 컨테이너 width 변화에 리사이즈

---

## 6. 기능 단위 명세

| ID | 기능 | 담당 | 설명 |
|----|------|------|------|
| Web_01-1 | 차트 기간 탭 | FE | 4개 탭 컴포넌트, 탭 변경 시 API 재호출 |
| Web_01-2 | 차트 렌더러 | FE | Plotly JSON 렌더링, 로딩/에러/빈 상태 처리 |
| Web_01-3 | 차트 API | BE | range→days 매핑, fig 생성→json 반환 |
| Web_01-4 | 캐시/성능 | BE | TTL 캐싱, 동일 요청 중복 방지 |

---

## 7. 종목 탐색 메인 화면

### 7-1. 화면 구성

```
┌─────────────────────────────────────────────────────────────────┐
│  [검색창]                                                        │
│  [전체] [관심 종목] [보유 종목]                                   │
├─────────────────────────────┬───────────────────────────────────┤
│                             │                                   │
│    종목 리스트 영역          │      선택 종목 차트 영역           │
│    (와이어프레임 1번)        │      (와이어프레임 2번)            │
│                             │                                   │
└─────────────────────────────┴───────────────────────────────────┘
```

### 7-2. 와이어프레임 1번 - 종목 리스트 영역

#### 상단 검색 영역

| 요소 | 설명 |
|------|------|
| 검색 입력창 | 주식 종목 검색 |
| 탭 버튼 | 전체 / 관심 종목 / 보유 종목 |

- 검색 입력 시 → 종목 상세 페이지로 즉시 이동
- 검색 X 상태에서만 종목 리스트 영역 유지

#### 종목 리스트 (기본 상태)

| 표시 정보 | 설명 |
|-----------|------|
| 종목명 | 회사 이름 |
| 현재가 | 현재 주가 |
| 등락률 | 전일 대비 % |

- 기본 탭: 전체
- 기본 정렬: 주가순

#### 탭별 정렬 옵션

| 탭 | 정렬 옵션 |
|----|-----------|
| 전체 | 주가순(기본), 상승률순, 거래량순 |
| 관심 종목 | 최근 추가순(기본), 등락률순, 종목명순 |
| 보유 종목 | 평가금액순(기본), 수익률순, 보유수량순, 종목명순 |

- **보유 종목 탭 조건**: 계좌 미연동 시 "계좌 연동 필요" 안내 표시

### 7-3. 와이어프레임 2번 - 선택 종목 차트 영역

#### 기본 차트 표시

| 요소 | 설명 |
|------|------|
| 차트 | 선택 종목의 차트 |
| 주기 버튼 | 하루 / 1달 / 3달 / 1년 |

- 기본 주기: 하루
- 기본 차트 타입: 캔들스틱 + MA(5, 20, 60)

#### 주기별 데이터 기준

| 주기 | 데이터 |
|------|--------|
| 하루 | 일중 차트 (5분봉) |
| 1달 | 일봉 |
| 3달 | 일봉 |
| 1년 | 일봉 |

#### 차트 갱신 조건

| 갱신됨 | 갱신 안됨 |
|--------|-----------|
| 종목 리스트에서 종목 선택 시 | 탭 전환만 수행 (종목 선택 없음) |
| 차트 주기 변경 시 | |

---

# (2) 종목 상세 리포트 페이지

**목적:** 챗봇 요약을 확장한 '읽기 쉬운 투자 리포트' 제공

| 영역 | 구성 요소 | 데이터 |
|------|-----------|--------|
| 상단 요약 | 한 줄 요약 | kakao.summary.brief_summary |
| 투자 의견 | 목표가 / 리스크 | investment_opinion |
| section Tab | 요약 / 주가 / 재무 / 의견 | sections.* |
| 원문 보기 | 전체 리포트 | report.full_text |
| 근거 데이터 | 지표 / 추이 카드 | raw_data.* |

---

# (3) 투자 내역 한눈 요약 페이지

**목적:** 초보자도 이해 가능한 월간 투자 요약 제공

| 영역 | 구성 요소 |
|------|-----------|
| 월간 요약 | 총 수익률, 손익 |
| 종목 요약 | 종목별 수익률 |
| 설명 블록 | 용어 설명 |

---

# Web_02. 뉴스/커뮤니티 탭

## 0. 전제/정책

- Web_02는 종목 상세 페이지 최하단 (블록 5)에 위치
- **계좌 연동 없이 사용 가능**
- 기본 탭: 커뮤니티

---

## 1. 화면 요구사항

### 1-1. 탭 구성

| 탭 | 설명 | 기본값 |
|----|------|--------|
| 커뮤니티 | 시장 반응/투자자 의견 | ✅ (기본) |
| 뉴스 | 투자 관련 뉴스 (필터링) | |

### 1-2. 커뮤니티 탭

| 요소 | 설명 |
|------|------|
| AI 요약 | 상단에 시장 반응 요약 표시 |
| 피드 리스트 | 제목, 내용 미리보기, 출처, 감성(긍정/중립/부정) |
| 무한 스크롤 | 페이지네이션 대신 무한 스크롤 적용 |
| 새 글 배너 | "새 글 N개" 배너 (실시간 폴링) |

### 1-3. 뉴스 탭

| 요소 | 설명 |
|------|------|
| 뉴스 리스트 | 제목, 내용 미리보기, 출처, 게시일 |
| 필터링 | 투자 관련 뉴스만 표시 (2단계 필터링) |
| 무한 스크롤 | 페이지네이션 대신 무한 스크롤 적용 |

---

## 2. 필터링 로직 (뉴스 탭)

### 2-1. 2단계 필터링

| 단계 | 방식 | 설명 |
|------|------|------|
| 1단계 | 키워드 필터 | 투자 관련 키워드 포함 여부 확인 |
| 2단계 | LLM 분류 | AI로 투자 판단 도움 여부 분류 (선택) |

### 2-2. 투자 관련 키워드

```
주가, 주식, 투자, 매수, 매도, 목표가, 실적,
영업이익, 매출, 배당, 공시, IR, 애널리스트,
증권, 펀드, ETF, 상승, 하락, 전망
```

---

## 3. API 명세

### 3-1. 뉴스 API

```
GET /api/web/stocks/{symbol}/news
```

**Query Parameters:**
| 파라미터 | 필수 | 기본값 | 설명 |
|----------|------|--------|------|
| page | ❌ | 1 | 페이지 번호 |
| limit | ❌ | 10 | 페이지당 개수 |

**Response:**
```json
{
  "symbol": "005930",
  "company_name": "삼성전자",
  "tab": "news",
  "page": 1,
  "limit": 10,
  "total_count": 15,
  "has_more": true,
  "items": [
    {
      "id": "news_1",
      "title": "삼성전자, HBM4 점유율 2배 확대 전망",
      "content": "KB증권은 삼성전자 목표주가를...",
      "url": "https://...",
      "source": "비즈니스포스트",
      "published_at": "2026-01-24 10:30:00",
      "is_investment_related": true
    }
  ],
  "fetched_at": "2026-01-24T10:30:00"
}
```

### 3-2. 커뮤니티 API

```
GET /api/web/stocks/{symbol}/community
```

**Query Parameters:**
| 파라미터 | 필수 | 기본값 | 설명 |
|----------|------|--------|------|
| page | ❌ | 1 | 페이지 번호 |
| limit | ❌ | 10 | 페이지당 개수 |
| last_id | ❌ | - | 마지막 조회 ID (새 글 확인용) |

**Response:**
```json
{
  "symbol": "005930",
  "company_name": "삼성전자",
  "tab": "community",
  "page": 1,
  "limit": 10,
  "total_count": 20,
  "has_more": true,
  "ai_summary": "애널리스트들은 삼성전자 HBM4 경쟁력에 긍정적...",
  "items": [
    {
      "id": "comm_1",
      "title": "KB증권 삼성전자 목표주가 20만원 유지",
      "content": "김동원 KB증권 연구원은...",
      "url": "https://...",
      "source": "비즈니스포스트",
      "sentiment": "positive",
      "published_at": "2026-01-24 10:30:00"
    }
  ],
  "fetched_at": "2026-01-24T10:30:00",
  "new_count": 0
}
```

**에러 응답:**
```json
{
  "error": "에러 메시지",
  "items": [],
  "fetched_at": "2026-01-24T10:30:00"
}
```

---

## 4. 프론트엔드 준비사항

### 4-1. 컴포넌트 구조

| 컴포넌트 | 역할 |
|----------|------|
| `NewsCommunityTabs` | 커뮤니티/뉴스 탭 전환 |
| `CommunityFeed` | 커뮤니티 피드 렌더링 |
| `NewsFeed` | 뉴스 피드 렌더링 |
| `FeedItem` | 개별 피드 아이템 |
| `NewBanner` | "새 글 N개" 배너 |
| `AISummary` | AI 요약 카드 |

### 4-2. 동작 흐름

1. **최초 진입**: `tab=community`, `page=1` 호출
2. **탭 클릭**: 로딩 스켈레톤 → API 재호출 → 피드 교체
3. **무한 스크롤**: `has_more=true`면 다음 페이지 호출
4. **실시간 폴링**: 5-10초 간격으로 새 글 확인 (커뮤니티 탭)
5. **실패 시**: 재시도 버튼 + 빈 상태 UI

### 4-3. 감성 표시 (커뮤니티)

| sentiment | 표시 |
|-----------|------|
| positive | 🟢 긍정 |
| neutral | ⚪ 중립 |
| negative | 🔴 부정 |

---

## 5. 기능 단위 명세

| ID | 기능 | 담당 | 설명 |
|----|------|------|------|
| Web_02-1 | 탭 전환 | FE | 커뮤니티/뉴스 탭 컴포넌트 |
| Web_02-2 | 무한 스크롤 | FE | 페이지네이션 없이 스크롤 로딩 |
| Web_02-3 | 새 글 배너 | FE | 실시간 폴링 + 배너 표시 |
| Web_02-4 | 뉴스 API | BE | 2단계 필터링 적용 |
| Web_02-5 | 커뮤니티 API | BE | AI 요약 + 감성 분석 |

---

## 6. 캐싱 정책

| 탭 | TTL | 비고 |
|----|-----|------|
| 커뮤니티 | 30초~1분 | 실시간성 필요 |
| 뉴스 | 5분 | 상대적으로 느린 갱신 |

---

## 데이터 연동 구조

```
┌─────────────────────────────────────────────────────────────────┐
│  카카오톡 챗봇                                                   │
│  ├─ 간단한 질문/응답                                            │
│  ├─ 요약 정보 제공                                              │
│  └─ webLink 버튼 → 웹 페이지 연결                               │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  Mobile Web (카카오톡 인앱 브라우저)                             │
│  ├─ (1) 종목 차트 페이지                                        │
│  ├─ (2) 종목 상세 리포트 페이지                                 │
│  ├─ (3) 투자 내역 요약 페이지                                   │
│  └─ (4) 뉴스/커뮤니티 반응 요약 페이지                          │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  Backend API                                                     │
│  ├─ 한국투자증권 API (시세, 거래내역)                            │
│  ├─ Tavily API (뉴스 검색)                                      │
│  └─ Gemini API (AI 분석/요약)                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

---

# Web_03. 물타기 계산기

## 0. 전제/정책

- Web_03 물타기 계산기는 **계좌 연동 필수**
- **보유 종목만** 계산 가능 (미보유 종목은 안내 메시지 표시)
- 종목 상세 페이지 하단에 위치 (스크롤 영역)
- 별도 페이지 이동 없이 현재 페이지 내에서 동작
- 데이터 갱신: 페이지 진입 시 1회 (실시간 갱신 없음)

---

## 1. 기능 위치 및 접근

### 1-1. 페이지 구조

```
[종목 상세 페이지]
├─ 헤더 (종목명, 현재가)
├─ 차트 영역 (Web_01)
├─ 뉴스/커뮤니티 탭 (Web_02)
└─ 물타기 계산기 영역 ← 스크롤 하단
```

### 1-2. 접근 조건

| 조건 | 상태 | 표시 내용 |
|------|------|-----------|
| 계좌 미연동 | ❌ | "물타기 계산은 계좌 연동 후 이용 가능합니다" + 연동 버튼 |
| 계좌 연동 + 보유 종목 | ✅ | 계산기 활성화 (보유 정보 자동 입력) |
| 계좌 연동 + 비보유 종목 | ❌ | "현재 보유 중이 아닙니다" 안내 |

---

## 2. 화면 요구사항

### 2-1. 입력 모드 선택

| 모드 | 설명 | 입력 필드 |
|------|------|-----------|
| **수량 기준** | 추가 매수할 수량을 직접 입력 | • 추가 매수 단가<br>• 추가 매수 수량 |
| **금액 기준** | 투자 금액을 입력하여 수량 자동 계산 | • 추가 투자 금액<br>• 매수 단가 |

- 기본 선택: 수량 기준
- 모드 토글 버튼으로 전환

### 2-2. 보유 정보 표시 (읽기 전용)

| 항목 | 설명 |
|------|------|
| 현재 평균 단가 | 보유 종목의 평단가 |
| 현재 보유 수량 | 보유 주식 수량 |
| 현재 주가 | 실시간 현재가 |
| 평가 손익 | 현재 손익 금액 및 비율 |

### 2-3. 계산 결과 표시

| 항목 | 강조 | 설명 |
|------|------|------|
| 새로운 평균 단가 | ✅ 대형 강조 | 물타기 후 새 평단가 |
| 평균 단가 변화 | ✅ 색상 | ▼ -455원 (-0.61%) |
| 총 보유 수량 | | 물타기 후 총 수량 |
| 총 투자 금액 | | 물타기 후 총 투자액 |
| 추가 투자 금액 | | 이번 물타기 투자액 |
| 손익 변화 | ✅ 색상 | 현재가 기준 평가 손익 |

### 2-4. 탭 및 히스토리

| 탭 | 설명 |
|------|------|
| 계산하기 | 기본 계산 화면 (기본 선택) |
| 이전 계산 | 저장된 계산 내역 조회 (최대 10개) |

**저장 방식:**
- 계산 완료 후 "이 계산 저장하기" 버튼으로 저장
- 저장된 계산은 "이전 계산" 탭에서 조회

---

## 3. 데이터 준비사항

### 3-1. 보유 종목 정보 조회

**데이터 소스:** HantuStock API (KIS API)

| 필드 | 설명 |
|------|------|
| symbol | 종목 코드 |
| company_name | 종목명 |
| quantity | 보유 수량 |
| avg_price | 평균 매수가 |
| current_price | 현재가 |
| total_cost | 총 투자 금액 |
| current_value | 현재 평가액 |
| profit_loss | 평가 손익 |
| profit_loss_pct | 수익률 (%) |

### 3-2. 계산 로직

**사용 모듈:** `averaging_calculator.py`

#### 수량 기준 계산

```python
# 입력
current_avg_price = 75000  # 현재 평단가
current_quantity = 100      # 현재 보유량
additional_price = 70000    # 추가 매수 단가
additional_quantity = 10    # 추가 매수 수량

# 계산
existing_cost = 75000 × 100 = 7,500,000
additional_cost = 70000 × 10 = 700,000
total_cost = 8,200,000
total_quantity = 110
new_avg_price = 8,200,000 ÷ 110 = 74,545원
```

#### 금액 기준 계산

```python
# 입력
current_avg_price = 75000   # 현재 평단가
current_quantity = 100       # 현재 보유량
investment_amount = 1000000  # 투자 금액
purchase_price = 70000       # 매수 단가

# 계산
calculated_quantity = 1,000,000 ÷ 70,000 = 14.28 → 14주 (소수점 버림)
actual_investment = 70,000 × 14 = 980,000
total_cost = 7,500,000 + 980,000 = 8,480,000
total_quantity = 114
new_avg_price = 8,480,000 ÷ 114 = 74,386원
```

---

## 4. API 명세

### 4-1. 공통 규칙

- `symbol` (종목코드): 필수
- 계좌 연동 필수: Authorization 헤더 또는 세션 인증
- 보유 종목 검증 필수

### 4-2. 보유 종목 정보 조회

```
GET /api/web/averaging/holding/{symbol}
```

**Response (보유):**
```json
{
  "symbol": "005930",
  "company_name": "삼성전자",
  "is_holding": true,
  "holding_info": {
    "quantity": 100,
    "avg_price": 75000,
    "current_price": 71300,
    "total_cost": 7500000,
    "current_value": 7130000,
    "profit_loss": -370000,
    "profit_loss_pct": -4.93,
    "fetched_at": "2026-01-28 10:30:00"
  }
}
```

**Response (미보유):**
```json
{
  "symbol": "005930",
  "company_name": "삼성전자",
  "is_holding": false,
  "message": "현재 보유 중이 아닙니다"
}
```

### 4-3. 수량 기준 계산

```
POST /api/web/averaging/calculate/quantity
```

**Request Body:**
```json
{
  "symbol": "005930",
  "additional_price": 70000,
  "additional_quantity": 10
}
```

**Response:**
```json
{
  "symbol": "005930",
  "company_name": "삼성전자",
  "calculation_mode": "quantity",
  "input": {
    "current_avg_price": 75000,
    "current_quantity": 100,
    "current_price": 71300,
    "additional_price": 70000,
    "additional_quantity": 10
  },
  "result": {
    "new_avg_price": 74545,
    "avg_price_change": -455,
    "avg_price_change_pct": -0.61,
    "total_quantity": 110,
    "total_cost": 8200000,
    "additional_cost": 700000,
    "breakeven_price": 74545,
    "profit_if_sell_now": -137000,
    "profit_pct": -1.67
  },
  "fetched_at": "2026-01-28 10:30:00"
}
```

### 4-4. 금액 기준 계산

```
POST /api/web/averaging/calculate/amount
```

**Request Body:**
```json
{
  "symbol": "005930",
  "investment_amount": 1000000,
  "purchase_price": 70000
}
```

**Response:**
```json
{
  "symbol": "005930",
  "company_name": "삼성전자",
  "calculation_mode": "amount",
  "input": {
    "current_avg_price": 75000,
    "current_quantity": 100,
    "current_price": 71300,
    "investment_amount": 1000000,
    "purchase_price": 70000,
    "calculated_quantity": 14
  },
  "result": {
    "new_avg_price": 74386,
    "avg_price_change": -614,
    "avg_price_change_pct": -0.82,
    "total_quantity": 114,
    "total_cost": 8480000,
    "additional_cost": 980000,
    "breakeven_price": 74386,
    "profit_if_sell_now": -168000,
    "profit_pct": -1.98
  },
  "fetched_at": "2026-01-28 10:30:00"
}
```

### 4-5. 계산 결과 저장

```
POST /api/web/averaging/save
```

**Request Body:**
```json
{
  "symbol": "005930",
  "calculation_mode": "quantity",
  "input": {
    "additional_price": 70000,
    "additional_quantity": 10
  },
  "result": {
    "new_avg_price": 74545,
    "total_quantity": 110,
    "total_cost": 8200000
  }
}
```

**Response:**
```json
{
  "calculation_id": "calc_20260128_103000_005930",
  "symbol": "005930",
  "saved_at": "2026-01-28 10:30:00",
  "message": "계산 결과가 저장되었습니다"
}
```

### 4-6. 계산 히스토리 조회

```
GET /api/web/averaging/history/{symbol}?limit=10
```

**Response:**
```json
{
  "symbol": "005930",
  "company_name": "삼성전자",
  "total_count": 5,
  "calculations": [
    {
      "calculation_id": "calc_20260128_103000_005930",
      "saved_at": "2026-01-28 10:30:00",
      "calculation_mode": "quantity",
      "input": {
        "additional_price": 70000,
        "additional_quantity": 10
      },
      "result_summary": {
        "new_avg_price": 74545,
        "total_quantity": 110,
        "total_cost": 8200000
      }
    }
  ]
}
```

### 4-7. 에러 응답

```json
{
  "error": "NOT_HOLDING",
  "message": "현재 삼성전자를 보유하고 있지 않습니다",
  "symbol": "005930",
  "company_name": "삼성전자"
}
```

### 4-8. 캐싱 정책

| API | TTL | 비고 |
|-----|-----|------|
| 보유 종목 정보 | 30초 | 실시간성 필요 |
| 계산 히스토리 | 5분 | 자주 변경 없음 |

---

## 5. 프론트엔드 준비사항

### 5-1. 컴포넌트 구조

| 컴포넌트 | 역할 |
|----------|------|
| `AveragingCalculator` | 전체 계산기 컨테이너 |
| `TabSelector` | 계산하기/이전 계산 탭 전환 |
| `ModeSelector` | 수량/금액 기준 모드 토글 |
| `HoldingInfo` | 현재 보유 정보 표시 (읽기 전용) |
| `QuantityInput` | 수량 기준 입력 폼 |
| `AmountInput` | 금액 기준 입력 폼 |
| `CalculationResult` | 계산 결과 표시 |
| `SaveButton` | 계산 결과 저장 |
| `HistoryListView` | 계산 히스토리 목록 (탭 내 표시) |
| `HistoryDetailView` | 히스토리 항목 상세 보기 |

### 5-2. 동작 흐름

#### 페이지 진입 시

1. 계좌 연동 상태 확인
   - 미연동 → 안내 메시지 + 연동 버튼
   - 연동 → 다음 단계
2. 보유 종목 확인 API 호출
   - 미보유 → 안내 메시지
   - 보유 → 계산기 활성화 + 보유 정보 표시

#### 계산 실행

1. 사용자 입력
   - 수량 기준: 추가 단가, 추가 수량
   - 금액 기준: 투자 금액, 매수 단가
2. 입력 검증
   - 필수 입력 확인
   - 양수 검증
   - 숫자 형식 검증
3. 계산 API 호출
   - 로딩 상태 표시
   - 결과 렌더링
4. 사용자 선택
   - 저장 → 히스토리 저장 API 호출
   - 다시 계산 → 입력 필드 초기화

#### 히스토리 조회

1. "이전 계산" 탭 클릭
2. API 호출 (GET /api/web/averaging/history/{symbol})
3. 탭 내에 히스토리 리스트 표시
4. 항목 클릭 시 상세 정보 표시 (모달 또는 확장 뷰)

### 5-3. 입력 검증

| 검증 항목 | 규칙 | 에러 메시지 |
|-----------|------|-------------|
| 필수 입력 | 빈 값 방지 | "입력값을 확인해주세요" |
| 양수 검증 | > 0 | "0보다 큰 값을 입력해주세요" |
| 숫자 형식 | 정수 또는 소수 | "숫자만 입력 가능합니다" |
| 최대값 | 합리적 범위 | "입력값이 너무 큽니다" |

---

## 6. 기능 단위 명세

| ID | 기능 | 담당 | 설명 |
|----|------|------|------|
| Web_03-1 | 보유 종목 조회 | BE | KIS API 연동, 평단가/수량/현재가 조회 |
| Web_03-2 | 수량 기준 계산 | BE | averaging_calculator.py 사용 |
| Web_03-3 | 금액 기준 계산 | BE | 수량 자동 계산 → 물타기 계산 |
| Web_03-4 | 계산 결과 저장 | BE | JSON 파일 저장 (./averaging_history/) |
| Web_03-5 | 히스토리 조회 | BE | 최신순 정렬, 최대 10개 |
| Web_03-6 | 모드 전환 | FE | 수량/금액 기준 토글 |
| Web_03-7 | 계산 결과 표시 | FE | 강조 렌더링, 색상 처리 |
| Web_03-8 | 히스토리 UI | FE | 탭 전환, 리스트 렌더링 |

---

## 7. 데이터 흐름

### 7-1. 전체 흐름

```
[페이지 진입]
     ↓
[계좌 연동 확인]
     ├─ 미연동 → 안내 메시지
     └─ 연동 → [보유 종목 조회]
                  ├─ 미보유 → 안내 메시지
                  └─ 보유 → [계산기 활성화]
                              ↓
                         [보유 정보 표시]
                              ↓
                         [사용자 입력]
                              ↓
                         [계산 실행]
                              ↓
                         [결과 표시]
                              ↓
                         [저장 옵션]
```

### 7-2. 저장 흐름

```
[계산 완료]
     ↓
[저장 버튼 클릭]
     ↓
[저장 API 호출]
- calculation_id 생성
- JSON 파일 저장
- ./averaging_history/{symbol}/calc_{timestamp}.json
     ↓
[저장 완료 토스트]
```

### 7-3. 히스토리 조회 흐름

```
[이전 계산 탭 클릭]
     ↓
[히스토리 API 호출]
- 종목별 필터링
- 최신순 정렬
- 최대 10개 조회
     ↓
[탭 내 리스트 표시]
- 리스트 렌더링
- 항목 클릭 시 상세 표시
```

---

## 8. 저장 구조

### 8-1. 저장 위치

```
./averaging_history/
├─ 005930/
│  ├─ calc_20260128_103000.json
│  ├─ calc_20260127_151500.json
│  └─ ...
├─ 000660/
│  └─ ...
└─ ...
```

### 8-2. 저장 형식

**파일명:** `calc_{timestamp}.json`

**내용:**
```json
{
  "calculation_id": "calc_20260128_103000_005930",
  "symbol": "005930",
  "company_name": "삼성전자",
  "saved_at": "2026-01-28 10:30:00",
  "calculation_mode": "quantity",
  "snapshot": {
    "current_avg_price": 75000,
    "current_quantity": 100,
    "current_price": 71300
  },
  "input": {
    "additional_price": 70000,
    "additional_quantity": 10
  },
  "result": {
    "new_avg_price": 74545,
    "avg_price_change": -455,
    "avg_price_change_pct": -0.61,
    "total_quantity": 110,
    "total_cost": 8200000,
    "additional_cost": 700000
  }
}
```

---

## 9. 에러 처리

### 9-1. 주요 에러 시나리오

| 에러 코드 | 원인 | 대응 |
|-----------|------|------|
| `ACCOUNT_NOT_LINKED` | 계좌 미연동 | 연동 안내 + 버튼 |
| `NOT_HOLDING` | 해당 종목 미보유 | 안내 메시지 |
| `API_ERROR` | KIS API 오류 | 재시도 안내 |
| `INVALID_INPUT` | 잘못된 입력 (0, 음수, 문자) | 인라인 에러 메시지 |
| `SAVE_FAILED` | 저장 실패 | 재시도 버튼 |

### 9-2. 에러 응답 예시

```json
{
  "error": "NOT_HOLDING",
  "message": "현재 삼성전자를 보유하고 있지 않습니다",
  "symbol": "005930",
  "company_name": "삼성전자"
}
```

---

## 10. 성능 및 최적화

### 10-1. 응답 시간 목표

| API | 목표 시간 |
|-----|-----------|
| 보유 종목 조회 | < 1초 |
| 계산 실행 | < 0.5초 |
| 저장 | < 0.5초 |
| 히스토리 조회 | < 1초 |

### 10-2. 캐싱 전략

| 데이터 | TTL | 캐시 키 |
|--------|-----|---------|
| 보유 종목 정보 | 30초 | `holding:{symbol}:{user_id}` |
| 계산 히스토리 | 5분 | `history:{symbol}:{user_id}` |

---

## 11. 와이어프레임 명세

### WF_03-0. 계좌 미연동 상태

```
┌─────────────────────────────────────┐
│  [물타기 계산기]                    │
├─────────────────────────────────────┤
│                                     │
│  🔒 물타기 계산은 계좌 연동 후      │
│     이용 가능합니다                 │
│                                     │
│         [계좌 연동하기]             │
│                                     │
└─────────────────────────────────────┘
```

### WF_03-1. 비보유 종목

```
┌─────────────────────────────────────┐
│  [물타기 계산기]                    │
├─────────────────────────────────────┤
│                                     │
│  ℹ️  현재 삼성전자를 보유하고       │
│     있지 않습니다                   │
│                                     │
└─────────────────────────────────────┘
```

### WF_03-2. 보유 종목 - 수량 기준 모드

```
┌─────────────────────────────────────┐
│  [물타기 계산기]                    │
├─────────────────────────────────────┤
│  [계산하기] [이전 계산]             │
├─────────────────────────────────────┤
│  [수량 기준] [금액 기준]            │
├─────────────────────────────────────┤
│  현재 보유 정보                     │
│  ├ 평균 단가: 75,000원              │
│  ├ 보유 수량: 100주                 │
│  ├ 현재 주가: 71,300원              │
│  └ 평가 손익: -370,000원 (-4.93%)   │
├─────────────────────────────────────┤
│  추가 매수 입력                     │
│  ├ 추가 단가: [70000]               │
│  └ 추가 수량: [10]                  │
├─────────────────────────────────────┤
│            [계산하기]               │
└─────────────────────────────────────┘
```

### WF_03-3. 보유 종목 - 금액 기준 모드

```
┌─────────────────────────────────────┐
│  [물타기 계산기]                    │
├─────────────────────────────────────┤
│  [계산하기] [이전 계산]             │
├─────────────────────────────────────┤
│  [수량 기준] [금액 기준]            │
├─────────────────────────────────────┤
│  현재 보유 정보                     │
│  ├ 평균 단가: 75,000원              │
│  ├ 보유 수량: 100주                 │
│  ├ 현재 주가: 71,300원              │
│  └ 평가 손익: -370,000원 (-4.93%)   │
├─────────────────────────────────────┤
│  추가 매수 입력                     │
│  ├ 투자 금액: [1000000]             │
│  └ 매수 단가: [70000]               │
├─────────────────────────────────────┤
│            [계산하기]               │
└─────────────────────────────────────┘
```

### WF_03-4. 계산 결과 표시

```
┌─────────────────────────────────────┐
│  [물타기 계산기]                    │
├─────────────────────────────────────┤
│  [계산하기] [이전 계산]             │
├─────────────────────────────────────┤
│  [수량 기준] [금액 기준]            │
├─────────────────────────────────────┤
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│  💰 계산 결과                       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━       │
│                                     │
│  ✅ 새 평단가                       │
│     74,545원                        │
│                                     │
│  ▼ 평단가 변화                      │
│     -455원 (-0.61%)                 │
│                                     │
│  📊 투자 현황                       │
│  ├ 총 보유: 110주                   │
│  ├ 총 투자금: 8,200,000원           │
│  └ 추가 투자: 700,000원             │
│                                     │
│  💸 현재 손익 (71,300원 기준)       │
│  📉 -137,000원 (-1.67%)             │
│                                     │
│  [이 계산 저장하기]                 │
│  [다시 계산하기] [이전 계산 보기]   │
│  [계산 종료]                        │
└─────────────────────────────────────┘
```

### WF_03-5. 이전 계산 탭 - 히스토리 목록

```
┌─────────────────────────────────────┐
│  [물타기 계산기]                    │
├─────────────────────────────────────┤
│  [계산하기] [이전 계산]             │
├─────────────────────────────────────┤
│                                     │
│  📌 2026-01-28 10:30                │
│  수량 기준 | +10주 @ 70,000원       │
│  → 새 평단가: 74,545원              │
│  ─────────────────────────────      │
│                                     │
│  📌 2026-01-27 15:15                │
│  금액 기준 | 1,000,000원            │
│  → 새 평단가: 74,386원              │
│  ─────────────────────────────      │
│                                     │
│  📌 2026-01-26 09:45                │
│  수량 기준 | +5주 @ 72,000원        │
│  → 새 평단가: 74,700원              │
│  ─────────────────────────────      │
│                                     │
│  [계산 종료]                        │
└─────────────────────────────────────┘
```

### WF_03-6. 이전 계산 탭 - 항목 상세 보기

```
┌─────────────────────────────────────┐
│  [물타기 계산기]                    │
├─────────────────────────────────────┤
│  [계산하기] [이전 계산]             │
├─────────────────────────────────────┤
│  📅 2026-01-28 10:30:00             │
│                                     │
│  【 입력 조건 】                    │
│  ├ 모드: 수량 기준                  │
│  ├ 추가 단가: 70,000원              │
│  └ 추가 수량: 10주                  │
│                                     │
│  【 계산 결과 】                    │
│  ✅ 새 평단가: 74,545원             │
│  ▼ 평단가 변화: -455원 (-0.61%)     │
│                                     │
│  【 투자 현황 】                    │
│  ├ 총 보유: 110주                   │
│  ├ 총 투자금: 8,200,000원           │
│  └ 추가 투자: 700,000원             │
│                                     │
│  [목록으로] [계산 종료]             │
└─────────────────────────────────────┘
```

### WF_03-7. 입력 에러 상태

```
┌─────────────────────────────────────┐
│  추가 매수 입력                     │
│  ├ 추가 단가: [70000]               │
│  └ 추가 수량: [0]                   │
│     ⚠️ 0보다 큰 값을 입력해주세요  │
├─────────────────────────────────────┤
│            [계산하기]               │
└─────────────────────────────────────┘
```

### WF_03-8. 로딩 상태

```
┌─────────────────────────────────────┐
│  [물타기 계산기]                    │
├─────────────────────────────────────┤
│  [계산하기] [이전 계산]             │
├─────────────────────────────────────┤
│                                     │
│        ⏳ 계산 중...                │
│                                     │
└─────────────────────────────────────┘
```

### WF_03-9. 저장 완료 토스트

```
         ✅ 계산 결과가 저장되었습니다
```

### WF_03-10. API 에러 상태

```
┌─────────────────────────────────────┐
│  [물타기 계산기]                    │
├─────────────────────────────────────┤
│  [계산하기] [이전 계산]             │
├─────────────────────────────────────┤
│                                     │
│  ⚠️  일시적인 오류가 발생했습니다   │
│                                     │
│         [다시 시도]                 │
│                                     │
└─────────────────────────────────────┘
```

### WF_03-11. 빈 히스토리

```
┌─────────────────────────────────────┐
│  [물타기 계산기]                    │
├─────────────────────────────────────┤
│  [계산하기] [이전 계산]             │
├─────────────────────────────────────┤
│                                     │
│  📭 저장된 계산 내역이 없습니다     │
│                                     │
│     계산 후 저장 버튼을 눌러        │
│     히스토리를 만들어보세요         │
│                                     │
│  [계산 종료]                        │
└─────────────────────────────────────┘
```

---

## 참고사항

- 웹 페이지는 카카오톡 인앱 브라우저에서 최적화되어야 함
- 초보자 타겟이므로 용어 설명 및 직관적 UI 필수
- 차트는 Plotly.js로 렌더링 (백엔드에서 fig.to_json() 전달)
- 물타기 계산기는 계좌 연동 필수 기능
